<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
body { background:#000; color:#fff; font-family:sans-serif; margin:0; padding:0; }
header { padding:20px; text-align:center; background:#111; }
h1 { margin:0; }
nav { display:flex; justify-content:center; margin:20px 0; flex-wrap: wrap; gap:10px; }
nav button { margin:0 10px; padding:10px 20px; background:#fff; color:#000; border:none; border-radius:5px; cursor:pointer; }
section { display:none; padding:20px; max-width:800px; margin:auto; }
section.active { display:block; }
input, select, textarea, button { display:block; margin:10px 0; padding:8px; width:100%; max-width:400px; border-radius:5px; border:none; }
button.submit-btn { background:#28a745; color:#fff; cursor:pointer; }
button.delete-btn { background:#dc3545; color:#fff; cursor:pointer; }
img.novedad { max-width:100%; border-radius:5px; margin-bottom:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:8px; border:1px solid #fff; text-align:left; }
</style>
</head>
<body>

<header>
<h1>Admin Panel</h1>
</header>

<nav>
  <div style="display:flex; gap:10px; width:100%; justify-content:center; flex-wrap: wrap;">
    <button onclick="showSection('usuarios')">Usuarios</button>
    <button onclick="showSection('novedades')">Novedades</button>
    <button onclick="showSection('novedadcrear')">Crear Novedad</button>
    <button onclick="showSection('ideas')">Ideas</button>
    <button onclick="showSection('tables')">Tables</button>
  </div>
</nav>

<!-- Panel Tables -->
<section id="tables">
  <h2>Tablas de la Base de Datos</h2>
  <button onclick="cargarTablas()">🔄 Refrescar Tablas</button>
  <div id="lista-tablas"></div>

  <h3>Crear Nueva Tabla</h3>
  <form id="form-crear-tabla">
    <input type="text" name="nombre" placeholder="Nombre de la tabla" required>
    <textarea name="columnas" placeholder="Ejemplo: id SERIAL PRIMARY KEY, nombre TEXT, edad INT" required></textarea>
    <button type="submit" class="submit-btn">Crear Tabla</button>
  </form>

  <div id="tabla-detalles"></div>
</section>

<!-- Panel Usuarios -->
<section id="usuarios" class="active">
<h2>Crear Usuario</h2>
<form id="form-crear-usuario">
<input type="text" name="username" placeholder="Usuario" required>
<input type="password" name="password" placeholder="Contraseña" required>
<select name="role">
<option value="admin">Admin</option>
<option value="normal">Normal</option>
</select>
<button type="submit" class="submit-btn">Crear</button>
</form>
<div id="usuarios-lista"></div>
</section>

<!-- Panel Novedades -->
<section id="novedades">
<h2>Lista de Novedades</h2>
<div id="novedades-lista"></div>
</section>

<!-- Panel Crear Novedad -->
<section id="novedadcrear">
<h2>Crear Novedad</h2>
<form id="form-crear-novedad" enctype="multipart/form-data">
<input type="text" name="asunto" placeholder="Asunto" required>
<textarea name="mensaje" placeholder="Mensaje" required></textarea>
<input type="file" name="foto" accept="image/*">
<button type="submit" class="submit-btn">Enviar Novedad</button>
</form>
</section>

<!-- Panel Ideas -->
<section id="ideas">
<h2>Ideas</h2>
<button onclick="window.location.href='/descargar-ideas'">Descargar Ideas</button>
</section>

<script>
// Cambiar sección
function showSection(id){
  document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// --- TABLAS ---
function cargarTablas(){
  fetch('/db/tables')
  .then(res=>res.json())
  .then(data=>{
    const lista=document.getElementById('lista-tablas');
    lista.innerHTML='';
    data.tablas.forEach(t=>{
      const div=document.createElement('div');
      div.style.margin="10px 0";
      div.innerHTML=`
        <strong>${t}</strong>
        <button onclick="verTabla('${t}')">Ver</button>
        <button class="delete-btn" onclick="borrarTabla('${t}')">Borrar</button>
      `;
      lista.appendChild(div);
    });
  });
}

function borrarTabla(nombre){
  if(confirm(`¿Borrar la tabla ${nombre}?`)){
    fetch(`/db/tables/${nombre}`, { method:'DELETE' })
    .then(()=> cargarTablas());
  }
}

function verTabla(nombre){
  fetch(`/db/table/${nombre}`)
  .then(res=>res.json())
  .then(data=>{
    const cont=document.getElementById('tabla-detalles');
    cont.innerHTML=`<h3>Tabla: ${nombre}</h3>`;

    if(data.registros.length===0){ 
      cont.innerHTML+="<p>Vacía</p>"; 
      return; 
    }

    // Borrar todos los registros
    const borrarTodosBtn = document.createElement('button');
    borrarTodosBtn.textContent='🗑️ Borrar todos los registros';
    borrarTodosBtn.className='delete-btn';
    borrarTodosBtn.onclick=()=>{
      if(confirm(`¿Borrar todos los registros de ${nombre}?`)){
        fetch(`/db/table/${nombre}/rows`,{method:'DELETE'}).then(()=>verTabla(nombre));
      }
    };
    cont.appendChild(borrarTodosBtn);

    const table=document.createElement('table');
    const thead=document.createElement('thead');
    const headRow=document.createElement('tr');

    Object.keys(data.registros[0]).forEach(col=>{
      const th=document.createElement('th'); th.textContent=col; headRow.appendChild(th);
    });
    const thAcc=document.createElement('th'); thAcc.textContent='Acción'; headRow.appendChild(thAcc);
    thead.appendChild(headRow);
    table.appendChild(thead);

    const tbody=document.createElement('tbody');
    data.registros.forEach(r=>{
      const tr=document.createElement('tr');
      Object.values(r).forEach(val=>{
        const td=document.createElement('td'); td.textContent=val; tr.appendChild(td);
      });
      const tdAcc=document.createElement('td');
      const btn=document.createElement('button');
      btn.textContent='Borrar';
      btn.className='delete-btn';
      btn.onclick=()=>{
        if(confirm('Borrar este registro?')){
          fetch(`/db/table/${nombre}/row/${r.id}`,{method:'DELETE'}).then(()=>verTabla(nombre));
        }
      };
      tdAcc.appendChild(btn);
      tr.appendChild(tdAcc);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    cont.appendChild(table);
  });
}

document.getElementById('form-crear-tabla').addEventListener('submit', e=>{
  e.preventDefault();
  const formData=new FormData(e.target);
  fetch('/db/tables',{method:'POST',body:formData})
  .then(res=>res.json())
  .then(()=>{ e.target.reset(); cargarTablas(); alert('✅ Tabla creada'); });
});

// --- USUARIOS ---
document.getElementById('form-crear-usuario').addEventListener('submit', e=>{
  e.preventDefault();
  const formData=new FormData(e.target);
  fetch('/crear-usuario',{method:'POST',body:formData})
  .then(res=>res.json())
  .then(data=>alert(data.msg))
  .catch(err=>console.error(err));
});

// --- NOVEDADES ---
document.getElementById('form-crear-novedad').addEventListener('submit', e=>{
  e.preventDefault();
  const formData=new FormData(e.target);
  fetch('/novedades',{method:'POST',body:formData})
  .then(res=>res.text())
  .then(()=>{
    e.target.reset();
    alert('✅ Novedad creada');
    cargarNovedades();
    showSection('novedades');
  })
  .catch(err=>console.error(err));
});

function cargarNovedades(){
  fetch('/ver-novedades')
  .then(res=>res.json())
  .then(data=>{
    const lista=document.getElementById('novedades-lista');
    lista.innerHTML='';
    data.novedades.forEach(n=>{
      const div=document.createElement('div');
      if(n.imagen){ const img=document.createElement('img'); img.src=n.imagen; img.className='novedad'; div.appendChild(img);}
      const h3=document.createElement('h3'); h3.textContent=n.asunto; div.appendChild(h3);
      const p=document.createElement('p'); p.textContent=n.mensaje; div.appendChild(p);

      const btn=document.createElement('button');
      btn.textContent='Borrar';
      btn.className='delete-btn';
      btn.onclick=()=>{
        if(confirm('Borrar novedad?')){
          fetch(`/borrar-novedad/${n.id}`,{method:'POST'}).then(()=>cargarNovedades());
        }
      };
      div.appendChild(btn);
      lista.appendChild(div);
    });
  });
}

document.addEventListener('DOMContentLoaded',()=>{ 
  cargarTablas();
  cargarNovedades(); 
});
</script>

</body>
</html>
